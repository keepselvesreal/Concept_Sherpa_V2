"""
ìƒì„± ì‹œê°„: 2025-08-12 15:00:45 KST
í•µì‹¬ ë‚´ìš©: 4ê°€ì§€ ì •ë³´(í•µì‹¬ ë‚´ìš©, ìƒì„¸ í•µì‹¬ ë‚´ìš©, ì£¼ìš” í™”ì œ, ë¶€ì°¨ í™”ì œ) ì¶”ì¶œì„ ìœ„í•œ ê³µí†µ ëª¨ë“ˆ
ìƒì„¸ ë‚´ìš©:
    - ContentAnalyzer í´ë˜ìŠ¤ (ë¼ì¸ 18-): 4ê°€ì§€ ì •ë³´ ì¶”ì¶œì„ ìœ„í•œ í•µì‹¬ í´ë˜ìŠ¤
    - analyze_content(content, title, context_type) (ë¼ì¸ 28-): 4ê°€ì§€ ì •ë³´ë¥¼ ë³‘ë ¬ë¡œ ì¶”ì¶œí•˜ëŠ” ë©”ì¸ ë©”ì„œë“œ
    - _analyze_core_content() (ë¼ì¸ 65-): í•µì‹¬ ë‚´ìš© ë¶„ì„
    - _analyze_detailed_content() (ë¼ì¸ 115-): ìƒì„¸ í•µì‹¬ ë‚´ìš© ë¶„ì„
    - _analyze_main_topics() (ë¼ì¸ 165-): ì£¼ìš” í™”ì œ ë¶„ì„
    - _analyze_sub_topics() (ë¼ì¸ 215-): ë¶€ì°¨ í™”ì œ ë¶„ì„
    - _extract_content_from_messages() (ë¼ì¸ 265-): ë©”ì‹œì§€ì—ì„œ í…ìŠ¤íŠ¸ ë‚´ìš© ì¶”ì¶œ ìœ í‹¸ë¦¬í‹°
ìƒíƒœ: í™œì„±
ì£¼ì†Œ: content_analysis_module
ì°¸ì¡°: dialectical_synthesis_processor.py (ê¸°ì¡´ ë¶„ì„ ë¡œì§ ì°¸ì¡°)
"""

import asyncio
from typing import Dict, List, Tuple, Optional
from claude_code_sdk import query, ClaudeCodeOptions
import logging


class ContentAnalyzer:
    """4ê°€ì§€ ì •ë³´ ì¶”ì¶œì„ ìœ„í•œ ê³µí†µ ëª¨ë“ˆ - ëª¨ë“  ë…¸ë“œ íƒ€ì…(ë¦¬í”„, ë‚´ë¶€, ë£¨íŠ¸)ì—ì„œ ì‚¬ìš© ê°€ëŠ¥"""
    
    def __init__(self, logger: Optional[logging.Logger] = None):
        self.logger = logger or logging.getLogger(__name__)
        
    async def analyze_content(self, content: str, title: str, context_type: str = "section") -> Dict[str, str]:
        """
        í…ìŠ¤íŠ¸ ë‚´ìš©ì—ì„œ 4ê°€ì§€ ì •ë³´ë¥¼ ë³‘ë ¬ë¡œ ì¶”ì¶œ
        
        Args:
            content: ë¶„ì„í•  í…ìŠ¤íŠ¸ ë‚´ìš©
            title: ì„¹ì…˜/ë…¸ë“œ ì œëª©
            context_type: ì»¨í…ìŠ¤íŠ¸ íƒ€ì… 
                - "section": ë‹¨ì¼ ì„¹ì…˜ ë¶„ì„
                - "combined": ì—¬ëŸ¬ í•˜ìœ„ ìš”ì†Œ ê²°í•© ë¶„ì„ 
                - "synthesis": ì •ë°˜í•© í†µí•© ë¶„ì„
                - "enhancement": ê¸°ì¡´ ì •ë³´ ê°œì„  ë¶„ì„
            
        Returns:
            Dict[str, str]: {'í•µì‹¬ ë‚´ìš©': content, 'ìƒì„¸ í•µì‹¬ ë‚´ìš©': content, 'ì£¼ìš” í™”ì œ': content, 'ë¶€ì°¨ í™”ì œ': content}
        """
        self.logger.info(f"4ê°€ì§€ ì •ë³´ ë¶„ì„ ì‹œì‘: {title} (íƒ€ì…: {context_type})")
        
        # ë³‘ë ¬ ë¶„ì„ ì‹¤í–‰
        tasks = [
            self._analyze_core_content(content, title, context_type),
            self._analyze_detailed_content(content, title, context_type),
            self._analyze_main_topics(content, title, context_type),
            self._analyze_sub_topics(content, title, context_type)
        ]
        
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # ê²°ê³¼ ì •ë¦¬
        analysis_result = {}
        sections = ["í•µì‹¬ ë‚´ìš©", "ìƒì„¸ í•µì‹¬ ë‚´ìš©", "ì£¼ìš” í™”ì œ", "ë¶€ì°¨ í™”ì œ"]
        
        for i, result in enumerate(results):
            section = sections[i]
            if isinstance(result, Exception):
                self.logger.error(f"âŒ {section} ë¶„ì„ ì‹¤íŒ¨: {result}")
                analysis_result[section] = f"ë¶„ì„ ì‹¤íŒ¨: {str(result)}"
            elif result and len(result) == 2:
                header, content_result = result
                analysis_result[section] = content_result
                self.logger.info(f"âœ… {section} ë¶„ì„ ì™„ë£Œ: {len(content_result)}ì")
            else:
                self.logger.warning(f"âš ï¸ {section} ë¶„ì„ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŒ")
                analysis_result[section] = ""
        
        success_count = sum(1 for v in analysis_result.values() if v and not v.startswith("ë¶„ì„ ì‹¤íŒ¨"))
        self.logger.info(f"ğŸ“Š ë¶„ì„ ì™„ë£Œ: {success_count}/4 ì„¹ì…˜ ì„±ê³µ")
        
        return analysis_result
    
    async def _analyze_core_content(self, content: str, title: str, context_type: str) -> Tuple[str, str]:
        """í•µì‹¬ ë‚´ìš© ë¶„ì„ - ì»¨í…ìŠ¤íŠ¸ íƒ€ì…ë³„ í”„ë¡¬í”„íŠ¸ ìµœì í™”"""
        prompt_templates = {
            "section": f"""ë‹¤ìŒì€ "{title}" ì„¹ì…˜ì˜ ë‚´ìš©ì…ë‹ˆë‹¤:

{content}

ì´ ì„¹ì…˜ì˜ í•µì‹¬ ë‚´ìš©ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”.
ì‘ë‹µì— 'í•µì‹¬ ë‚´ìš©'ì´ë¼ëŠ” í—¤ë”ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.""",
            
            "combined": f"""ë‹¤ìŒì€ "{title}"ì„ êµ¬ì„±í•˜ëŠ” ëª¨ë“  í•˜ìœ„ ìš”ì†Œë“¤ì˜ ë‚´ìš©ì„ ê²°í•©í•œ ê²ƒì…ë‹ˆë‹¤:

{content}

ì´ ì „ì²´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ "{title}"ì˜ í•µì‹¬ ë‚´ìš©ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.
ê° êµ¬ì„± ìš”ì†Œì˜ í•µì‹¬ì„ í†µí•©ì ìœ¼ë¡œ ë°˜ì˜í•˜ì—¬ ì „ì²´ì ì¸ ê´€ì ì—ì„œ ì •ë¦¬í•´ì£¼ì„¸ìš”.
ì‘ë‹µì— 'í•µì‹¬ ë‚´ìš©'ì´ë¼ëŠ” í—¤ë”ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.""",
            
            "synthesis": f"""ë‹¤ìŒì€ ì—…ë°ì´íŠ¸ëœ ëª¨ë“  êµ¬ì„± ìš”ì†Œë“¤ì˜ ì •ë³´ë¥¼ ê²°í•©í•œ ë‚´ìš©ì…ë‹ˆë‹¤:

{content}

ê¸°ì¡´ ìƒìœ„ ì„¹ì…˜ì˜ í•µì‹¬ ë‚´ìš©ì„ ì£¼ëœ ë‚´ìš©ìœ¼ë¡œ ìœ ì§€í•˜ë©´ì„œ, ì—…ë°ì´íŠ¸ëœ ê° êµ¬ì„± ìš”ì†Œì˜ í•µì‹¬ì„ ë°˜ì˜í•˜ì—¬ ë³´ë‹¤ í†µí•©ì ì¸ ê´€ì ìœ¼ë¡œ ê°œì„ í•´ì£¼ì„¸ìš”.
2-3ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ê³ , ì‘ë‹µì— 'í•µì‹¬ ë‚´ìš©'ì´ë¼ëŠ” í—¤ë”ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.""",
            
            "enhancement": f"""ë‹¤ìŒì€ "{title}"ì˜ ê¸°ì¡´ ì •ë³´ì™€ ë³´ì™„ ì •ë³´ì…ë‹ˆë‹¤:

{content}

ê¸°ì¡´ í•µì‹¬ ë‚´ìš©ì„ ì£¼ëœ ë‚´ìš©ìœ¼ë¡œ ìœ ì§€í•˜ë©´ì„œ, ë³´ì™„ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ë” ë‚˜ì€ í•µì‹¬ ë‚´ìš©ìœ¼ë¡œ ê°œì„ í•´ì£¼ì„¸ìš”.
2-3ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ê³ , ì‘ë‹µì— 'í•µì‹¬ ë‚´ìš©'ì´ë¼ëŠ” í—¤ë”ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”."""
        }
        
        prompt = prompt_templates.get(context_type, prompt_templates["section"])
        
        try:
            messages = []
            async for message in query(
                prompt=prompt,
                options=ClaudeCodeOptions(
                    max_turns=1,
                    system_prompt=f"í…ìŠ¤íŠ¸ ë¶„ì„ ì „ë¬¸ê°€. {title}ì˜ í•µì‹¬ ë‚´ìš©ì„ ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ìš”ì•½í•˜ì„¸ìš”.",
                    allowed_tools=[]
                )
            ):
                messages.append(message)
            
            content_result = self._extract_content_from_messages(messages)
            return ('í•µì‹¬ ë‚´ìš©', content_result)
            
        except Exception as e:
            self.logger.error(f"í•µì‹¬ ë‚´ìš© ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return ('í•µì‹¬ ë‚´ìš©', f"ë¶„ì„ ì‹¤íŒ¨: {str(e)}")

    async def _analyze_detailed_content(self, content: str, title: str, context_type: str) -> Tuple[str, str]:
        """ìƒì„¸ í•µì‹¬ ë‚´ìš© ë¶„ì„ - ì»¨í…ìŠ¤íŠ¸ íƒ€ì…ë³„ í”„ë¡¬í”„íŠ¸ ìµœì í™”"""
        prompt_templates = {
            "section": f"""ë‹¤ìŒì€ "{title}" ì„¹ì…˜ì˜ ë‚´ìš©ì…ë‹ˆë‹¤:

{content}

ì´ ì„¹ì…˜ì˜ ìƒì„¸ í•µì‹¬ ë‚´ìš©ì„ ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.
í—¤ë”ë¥¼ ì‚¬ìš©í•  ê²½ìš° ### 3ë ˆë²¨ë¶€í„° ì‚¬ìš©í•˜ê³ , ì‘ë‹µì— 'ìƒì„¸ í•µì‹¬ ë‚´ìš©'ì´ë¼ëŠ” í—¤ë”ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.""",
            
            "combined": f"""ë‹¤ìŒì€ "{title}"ì„ êµ¬ì„±í•˜ëŠ” ëª¨ë“  í•˜ìœ„ ìš”ì†Œë“¤ì˜ ë‚´ìš©ì„ ê²°í•©í•œ ê²ƒì…ë‹ˆë‹¤:

{content}

ì´ ì „ì²´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ "{title}"ì˜ ìƒì„¸ í•µì‹¬ ë‚´ìš©ì„ ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.
ê° êµ¬ì„± ìš”ì†Œë“¤ ê°„ì˜ ê´€ê³„ì™€ ì „ì²´ì ì¸ íë¦„ì„ ê³ ë ¤í•˜ì—¬ í¬ê´„ì ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”.
í—¤ë”ë¥¼ ì‚¬ìš©í•  ê²½ìš° ### 3ë ˆë²¨ë¶€í„° ì‚¬ìš©í•˜ê³ , ì‘ë‹µì— 'ìƒì„¸ í•µì‹¬ ë‚´ìš©'ì´ë¼ëŠ” í—¤ë”ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.""",
            
            "synthesis": f"""ë‹¤ìŒì€ ì—…ë°ì´íŠ¸ëœ ëª¨ë“  êµ¬ì„± ìš”ì†Œë“¤ì˜ ì •ë³´ë¥¼ ê²°í•©í•œ ë‚´ìš©ì…ë‹ˆë‹¤:

{content}

ê¸°ì¡´ ìƒìœ„ ì„¹ì…˜ì˜ ìƒì„¸ í•µì‹¬ ë‚´ìš©ì„ ì£¼ëœ ë‚´ìš©ìœ¼ë¡œ ìœ ì§€í•˜ë©´ì„œ, ì—…ë°ì´íŠ¸ëœ ê° êµ¬ì„± ìš”ì†Œì˜ í•µì‹¬ì„ ë°˜ì˜í•˜ì—¬ ë³´ë‹¤ í†µí•©ì ì¸ ê´€ì ìœ¼ë¡œ ê°œì„ í•´ì£¼ì„¸ìš”.
ì „ì²´ì˜ êµ¬ì¡°ì™€ íë¦„ì„ ë°˜ì˜í•œ í¬ê´„ì  ì„¤ëª…ì„ ì œê³µí•˜ì„¸ìš”.
í—¤ë”ë¥¼ ì‚¬ìš©í•  ê²½ìš° ### 3ë ˆë²¨ë¶€í„° ì‚¬ìš©í•˜ê³ , ì‘ë‹µì— 'ìƒì„¸ í•µì‹¬ ë‚´ìš©'ì´ë¼ëŠ” í—¤ë”ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.""",
            
            "enhancement": f"""ë‹¤ìŒì€ "{title}"ì˜ ê¸°ì¡´ ì •ë³´ì™€ ë³´ì™„ ì •ë³´ì…ë‹ˆë‹¤:

{content}

ê¸°ì¡´ ìƒì„¸ í•µì‹¬ ë‚´ìš©ì„ ì£¼ëœ ë‚´ìš©ìœ¼ë¡œ ìœ ì§€í•˜ë©´ì„œ, ë³´ì™„ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ë” í¬ê´„ì ì´ê³  ì²´ê³„ì ì¸ ìƒì„¸ ë‚´ìš©ìœ¼ë¡œ ê°œì„ í•´ì£¼ì„¸ìš”.
í—¤ë”ë¥¼ ì‚¬ìš©í•  ê²½ìš° ### 3ë ˆë²¨ë¶€í„° ì‚¬ìš©í•˜ê³ , ì‘ë‹µì— 'ìƒì„¸ í•µì‹¬ ë‚´ìš©'ì´ë¼ëŠ” í—¤ë”ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”."""
        }
        
        prompt = prompt_templates.get(context_type, prompt_templates["section"])
        
        try:
            messages = []
            async for message in query(
                prompt=prompt,
                options=ClaudeCodeOptions(
                    max_turns=1,
                    system_prompt=f"í…ìŠ¤íŠ¸ ë¶„ì„ ì „ë¬¸ê°€. {title}ì˜ ìƒì„¸í•œ ë‚´ìš©ì„ ì²´ê³„ì ì´ê³  í¬ê´„ì ìœ¼ë¡œ ì •ë¦¬í•˜ì„¸ìš”.",
                    allowed_tools=[]
                )
            ):
                messages.append(message)
            
            content_result = self._extract_content_from_messages(messages)
            return ('ìƒì„¸ í•µì‹¬ ë‚´ìš©', content_result)
            
        except Exception as e:
            self.logger.error(f"ìƒì„¸ í•µì‹¬ ë‚´ìš© ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return ('ìƒì„¸ í•µì‹¬ ë‚´ìš©', f"ë¶„ì„ ì‹¤íŒ¨: {str(e)}")

    async def _analyze_main_topics(self, content: str, title: str, context_type: str) -> Tuple[str, str]:
        """ì£¼ìš” í™”ì œ ë¶„ì„ - ì»¨í…ìŠ¤íŠ¸ íƒ€ì…ë³„ í”„ë¡¬í”„íŠ¸ ìµœì í™”"""
        prompt_templates = {
            "section": f"""ë‹¤ìŒì€ "{title}" ì„¹ì…˜ì˜ ë‚´ìš©ì…ë‹ˆë‹¤:

{content}

ì´ ì„¹ì…˜ì—ì„œ ë‹¤ë£¨ëŠ” ì£¼ìš” í™”ì œë“¤ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.
ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš” (- ê¸°í˜¸ë¡œ ì‹œì‘):
- ì£¼ìš” í™”ì œ1(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©
- ì£¼ìš” í™”ì œ2(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©

ë°˜ë“œì‹œ - ê¸°í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ëª©ë¡ í˜•íƒœë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”.""",
            
            "combined": f"""ë‹¤ìŒì€ "{title}"ì„ êµ¬ì„±í•˜ëŠ” ëª¨ë“  í•˜ìœ„ ìš”ì†Œë“¤ì˜ ë‚´ìš©ì„ ê²°í•©í•œ ê²ƒì…ë‹ˆë‹¤:

{content}

ì´ ì „ì²´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ "{title}"ì—ì„œ ë‹¤ë£¨ëŠ” ì£¼ìš” í™”ì œë“¤ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.
ê° êµ¬ì„± ìš”ì†Œì—ì„œ ë‚˜ì˜¨ ì£¼ìš” í™”ì œë“¤ì„ ëª¨ë‘ í¬í•¨í•˜ë˜, ì „ì²´ì ì¸ ê´€ì ì—ì„œ í†µí•©ì ìœ¼ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš” (- ê¸°í˜¸ë¡œ ì‹œì‘):
- ì£¼ìš” í™”ì œ1(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©
- ì£¼ìš” í™”ì œ2(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©

ë°˜ë“œì‹œ - ê¸°í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ëª©ë¡ í˜•íƒœë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”.""",
            
            "synthesis": f"""ë‹¤ìŒì€ ì—…ë°ì´íŠ¸ëœ ëª¨ë“  êµ¬ì„± ìš”ì†Œë“¤ì˜ ì •ë³´ë¥¼ ê²°í•©í•œ ë‚´ìš©ì…ë‹ˆë‹¤:

{content}

ê° êµ¬ì„± ìš”ì†Œì˜ ì£¼ìš” í™”ì œë“¤ì„ ëª¨ë‘ í¬í•¨í•˜ë˜, ì¶œì²˜ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ í‘œì‹œ:
- ëŒ€ë¶€ë¶„ì€ êµ¬ì²´ì ì¸ êµ¬ì„± ìš”ì†Œëª…ìœ¼ë¡œ í‘œì‹œ (ì˜ˆ: [ì¶œì²˜: 7_Introduction])
- ì¼ë¶€ í™”ì œëŠ” ì „ì²´ì  ê´€ì ì—ì„œ í†µí•©ëœ ê²ƒìœ¼ë¡œ í‘œì‹œ (ì˜ˆ: [ì¶œì²˜: ì „ì²´ ê´€ì ])

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš” (- ê¸°í˜¸ë¡œ ì‹œì‘):
- ì£¼ìš” í™”ì œ1(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš© [ì¶œì²˜: 7_Introduction]
- ì£¼ìš” í™”ì œ2(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš© [ì¶œì²˜: ì „ì²´ ê´€ì ]

ë°˜ë“œì‹œ - ê¸°í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ëª©ë¡ í˜•íƒœë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”.""",
            
            "enhancement": f"""ë‹¤ìŒì€ "{title}"ì˜ ê¸°ì¡´ ì •ë³´ì™€ ë³´ì™„ ì •ë³´ì…ë‹ˆë‹¤:

{content}

ê¸°ì¡´ ì£¼ìš” í™”ì œë“¤ì„ ì£¼ëœ ë‚´ìš©ìœ¼ë¡œ ìœ ì§€í•˜ë©´ì„œ, ë³´ì™„ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ë” ì™„ì „í•œ ì£¼ìš” í™”ì œ ëª©ë¡ìœ¼ë¡œ ê°œì„ í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš” (- ê¸°í˜¸ë¡œ ì‹œì‘):
- ì£¼ìš” í™”ì œ1(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©
- ì£¼ìš” í™”ì œ2(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©

ë°˜ë“œì‹œ - ê¸°í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ëª©ë¡ í˜•íƒœë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”."""
        }
        
        prompt = prompt_templates.get(context_type, prompt_templates["section"])
        
        try:
            messages = []
            async for message in query(
                prompt=prompt,
                options=ClaudeCodeOptions(
                    max_turns=1,
                    system_prompt=f"í…ìŠ¤íŠ¸ ë¶„ì„ ì „ë¬¸ê°€. {title}ì—ì„œ ë‹¤ë£¨ëŠ” ì£¼ìš” í™”ì œë¥¼ ì²´ê³„ì ìœ¼ë¡œ ì‹ë³„í•˜ê³  ì •ë¦¬í•˜ì„¸ìš”.",
                    allowed_tools=[]
                )
            ):
                messages.append(message)
            
            content_result = self._extract_content_from_messages(messages)
            return ('ì£¼ìš” í™”ì œ', content_result)
            
        except Exception as e:
            self.logger.error(f"ì£¼ìš” í™”ì œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return ('ì£¼ìš” í™”ì œ', f"ë¶„ì„ ì‹¤íŒ¨: {str(e)}")

    async def _analyze_sub_topics(self, content: str, title: str, context_type: str) -> Tuple[str, str]:
        """ë¶€ì°¨ í™”ì œ ë¶„ì„ - ì»¨í…ìŠ¤íŠ¸ íƒ€ì…ë³„ í”„ë¡¬í”„íŠ¸ ìµœì í™”"""
        prompt_templates = {
            "section": f"""ë‹¤ìŒì€ "{title}" ì„¹ì…˜ì˜ ë‚´ìš©ì…ë‹ˆë‹¤:

{content}

ì´ ì„¹ì…˜ì—ì„œ ë‹¤ë£¨ëŠ” ë¶€ì°¨ì ì¸ í™”ì œë“¤ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.
ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš” (- ê¸°í˜¸ë¡œ ì‹œì‘):
- ë¶€ì°¨ í™”ì œ1(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©
- ë¶€ì°¨ í™”ì œ2(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©

ë°˜ë“œì‹œ - ê¸°í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ëª©ë¡ í˜•íƒœë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”.""",
            
            "combined": f"""ë‹¤ìŒì€ "{title}"ì„ êµ¬ì„±í•˜ëŠ” ëª¨ë“  í•˜ìœ„ ìš”ì†Œë“¤ì˜ ë‚´ìš©ì„ ê²°í•©í•œ ê²ƒì…ë‹ˆë‹¤:

{content}

ì´ ì „ì²´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ "{title}"ì—ì„œ ë‹¤ë£¨ëŠ” ë¶€ì°¨ì ì¸ í™”ì œë“¤ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.
ê° êµ¬ì„± ìš”ì†Œì—ì„œ ë‚˜ì˜¨ ë¶€ì°¨ í™”ì œë“¤ì„ ëª¨ë‘ í¬í•¨í•˜ë˜, ì „ì²´ì ì¸ ê´€ì ì—ì„œ í†µí•©ì ìœ¼ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš” (- ê¸°í˜¸ë¡œ ì‹œì‘):
- ë¶€ì°¨ í™”ì œ1(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©
- ë¶€ì°¨ í™”ì œ2(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©

ë°˜ë“œì‹œ - ê¸°í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ëª©ë¡ í˜•íƒœë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”.""",
            
            "synthesis": f"""ë‹¤ìŒì€ ì—…ë°ì´íŠ¸ëœ ëª¨ë“  êµ¬ì„± ìš”ì†Œë“¤ì˜ ì •ë³´ë¥¼ ê²°í•©í•œ ë‚´ìš©ì…ë‹ˆë‹¤:

{content}

ê° êµ¬ì„± ìš”ì†Œì˜ ë¶€ì°¨ í™”ì œë“¤ì„ ëª¨ë‘ í¬í•¨í•˜ë˜, ì¶œì²˜ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ í‘œì‹œ:
- ëŒ€ë¶€ë¶„ì€ êµ¬ì²´ì ì¸ êµ¬ì„± ìš”ì†Œëª…ìœ¼ë¡œ í‘œì‹œ (ì˜ˆ: [ì¶œì²˜: 7_Introduction])
- ì¼ë¶€ í™”ì œëŠ” ì „ì²´ì  ê´€ì ì—ì„œ í†µí•©ëœ ê²ƒìœ¼ë¡œ í‘œì‹œ (ì˜ˆ: [ì¶œì²˜: ì „ì²´ ê´€ì ])

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš” (- ê¸°í˜¸ë¡œ ì‹œì‘):
- ë¶€ì°¨ í™”ì œ1(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš© [ì¶œì²˜: 7_Introduction]
- ë¶€ì°¨ í™”ì œ2(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš© [ì¶œì²˜: ì „ì²´ ê´€ì ]

ë°˜ë“œì‹œ - ê¸°í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ëª©ë¡ í˜•íƒœë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”.""",
            
            "enhancement": f"""ë‹¤ìŒì€ "{title}"ì˜ ê¸°ì¡´ ì •ë³´ì™€ ë³´ì™„ ì •ë³´ì…ë‹ˆë‹¤:

{content}

ê¸°ì¡´ ë¶€ì°¨ í™”ì œë“¤ì„ ì£¼ëœ ë‚´ìš©ìœ¼ë¡œ ìœ ì§€í•˜ë©´ì„œ, ë³´ì™„ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ë” ì™„ì „í•œ ë¶€ì°¨ í™”ì œ ëª©ë¡ìœ¼ë¡œ ê°œì„ í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš” (- ê¸°í˜¸ë¡œ ì‹œì‘):
- ë¶€ì°¨ í™”ì œ1(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©
- ë¶€ì°¨ í™”ì œ2(êµ¬ì²´ì ì¸ ì£¼ì œëª…): ì´ í™”ì œì— ëŒ€í•´ ë‹¤ë£¨ëŠ” ë‚´ìš©

ë°˜ë“œì‹œ - ê¸°í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ëª©ë¡ í˜•íƒœë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”."""
        }
        
        prompt = prompt_templates.get(context_type, prompt_templates["section"])
        
        try:
            messages = []
            async for message in query(
                prompt=prompt,
                options=ClaudeCodeOptions(
                    max_turns=1,
                    system_prompt=f"í…ìŠ¤íŠ¸ ë¶„ì„ ì „ë¬¸ê°€. {title}ì—ì„œ ë‹¤ë£¨ëŠ” ë¶€ì°¨ í™”ì œë¥¼ ì²´ê³„ì ìœ¼ë¡œ ì‹ë³„í•˜ê³  ì •ë¦¬í•˜ì„¸ìš”.",
                    allowed_tools=[]
                )
            ):
                messages.append(message)
            
            content_result = self._extract_content_from_messages(messages)
            return ('ë¶€ì°¨ í™”ì œ', content_result)
            
        except Exception as e:
            self.logger.error(f"ë¶€ì°¨ í™”ì œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return ('ë¶€ì°¨ í™”ì œ', f"ë¶„ì„ ì‹¤íŒ¨: {str(e)}")
    
    def _extract_content_from_messages(self, messages: List) -> str:
        """ë©”ì‹œì§€ì—ì„œ í…ìŠ¤íŠ¸ ë‚´ìš© ì¶”ì¶œ ìœ í‹¸ë¦¬í‹°"""
        content = ""
        for message in messages:
            if hasattr(message, 'content'):
                if isinstance(message.content, list):
                    for block in message.content:
                        if hasattr(block, 'text'):
                            content += block.text
                else:
                    content += str(message.content)
        return content.strip()