# 10.2 Storing data in the database

**페이지**: 232-235
**계층**: Data-Oriented Programming (node0) > Part2—Scalability (node1) > 10 Database operations (node2) > Chapter 10
**추출 시간**: 2025-08-06 19:47:10

---


--- 페이지 232 ---

204 CHAPTER 10 Database operations
Listing10.6 Searching books in the database, returning the results in JSON
dbClient holds the Initializes Ajv (a JSON schema validation
var dbClient; DB connection. library) with allErrors: true to catch all
the data validation errors
var ajv = new Ajv({allErrors: true});
var title = "habit";
var matchingBooksQuery = `SELECT title, isbn Uses a parameterized
SQL query as a security
FROM books
best practice
WHERE title LIKE '%$1%'`;
var books = dbClient.query(matchingBooksQuery,
Passes the parameters to the SQL
[title]);
query as a list of values (in our
if(!ajv.validate(dbSearchResultSchema, books)) {
case, a list with a single value)
var errors = ajv.errorsText(ajv.errors);
throw "Internal error: Unexpected result from the database: " + errors;
}
JSON.stringify(books);
Theo In a dynamically-typed language like JavaScript, I understand that the types of
the values in the list of maps returned by dbClient.query are determined at
run time. How does it work in a statically-typed language like Java, and what are
the types of the data fields in books?
Joe The function convertJDBCResultSetToListOfMaps we created earlier (see
listing 10.5) returns a list of Map<String, Object>. But JSON serialization
libraries like Gson know how to detect at run time the concrete type of the val-
ues in a map and serialize the values according to their type.
 NOTE See https://github.com/google/gson for information about Gson’s Java
serialization/deserialization library.
Theo What do you mean by serializing a value according to its type?
Joe For instance, the value of the field publication_year is a number; therefore,
it is not wrapped with quotes. However, the value of the field title is a string;
therefore, it is wrapped with quotes.
Theo Nice! Now, I understand what you mean by late binding.
Joe Cool! Now, let me show you how we store data in the database.
10.2 Storing data in the database
In the previous section, we saw how to retrieve data from the database as a list of maps.
Next, we’ll see how to store data in the database when data is represented with a map.
Theo I guess that storing data in the database is quite similar to fetching data from
the database.
Joe It’s similar in the sense that we deal only with generic data collections. Can you
write a parameterized SQL query that inserts a row with user info using only
email and encrypted_password, please?
Theo OK.

--- 페이지 232 끝 ---


--- 페이지 233 ---

10.2 Storing data in the database 205
Theo takes a moment to think about the code and writes a few lines of SQL as Joe
requested. He shows it to Joe.
Listing10.7 SQL statement to add a member
INSERT
INTO members
(email, encrypted_password)
VALUES ($1, $2)
Joe Great! And here’s how to integrate your SQL query in our application code.
Listing10.8 Adding a member from inside the application
var addMemberQuery =
"INSERT INTO members (email, password) VALUES ($1, $2)";
dbClient.query(addMemberQuery,
Passes the two parameters to
[_.get(member, "email"),
the SQL query as an array
_.get(member, "encryptedPassword")]);
Theo Your code is very clear, but something still bothers me.
Joe What is that?
Theo I find it cumbersome that you use _.get(user, "email") instead of user
.email, like I would if the data were represented with a class.
Joe In JavaScript, you are allowed to use the dot notation user.email instead of
_.get(user, "email").
Theo Then why don’t you use the dot notation?
Joe Because I wanted to show you how you can apply DOP principles even in lan-
guages like Java, where the dot notation is not available for hash maps.
 NOTE In this book, we avoid using the JavaScript dot notation to access a field in a
hash map in order to illustrate how to apply DOP in languages that don’t support dot
notation on hash maps.
Theo That’s exactly my point. I find it cumbersome in a language like Java to use
_.get(user, "email") instead of user.email like I would if the data were
represented with a class.
Joe On one hand, it’s cumbersome. On the other hand, representing data with a
hash map instead of a static class allows you to access fields in a flexible way.
Theo I know—you’ve told me so many times! But I can’t get used to it.
Joe Let me give you another example of the benefits of the flexible access to data
fields in the context of adding a member to the database. You said that writing
[_.get(member, "email"), _.get(member, "encryptedPassword")] was
less convenient than writing [member.email, member.encryptedPassword].
Right?
Theo Absolutely!
Joe Let me show you how to write the same code in a more succinct way, using a
function from Lodash called _.at.

--- 페이지 233 끝 ---


--- 페이지 234 ---

206 CHAPTER 10 Database operations
Theo What does this _.at function do?
Joe It receives a map m, a list keyList, and returns a list made of the values in m
associated with the keys in keyList.
Theo How about an example?
Joe Sure. We create a list made of the fields email and encryptedPassword of a
member.
Joe types for a bit. He shows this code to Theo.
Listing10.9 Creating a list made of some values in a map with _.at
var member = {
"email": "samantha@gmail.com",
"encryptedPassword": "c2VjcmV0",
"isBlocked": false
};
_.at(member,
["email", "encryptedPassword"]);
// ? ["samantha@gmail.com", "c2VjcmV0"]
Theo Do the values in the results appear in the same order as the keys in keyList?
Joe Yes!
Theo That’s cool.
TIP Accessing a field in a hash map is more flexible than accessing a member in an
object instantiated from a class.
Joe And here’s the code for adding a member using _.at.
Listing10.10 Using _.at to return multiple values from a map
class CatalogDB {
static addMember(member) {
var addMemberQuery = `INSERT
INTO members
(email, encrypted_password)
VALUES ($1, $2)`;
dbClient.query(addMemberQuery,
_.at(member, ["email",
"encryptedPassword"]));
}
}
Theo I can see how the _.at function becomes really beneficial when we need to
pass a bigger number of field values.
Joe I’ll be showing you more examples that use the flexible data access that we
have in DOP.

--- 페이지 234 끝 ---


--- 페이지 235 ---

10.3 Simple data manipulation 207
10.3 Simple data manipulation
Quite often, in a production application, we need to reshape data fetched from the
database. The simplest case is when we need to rename the columns from the data-
base to those that are more appropriate for our application.
Joe Did you notice that the column names in our database follow the snake case
convention?
Theo I’m so used to the convention, no. I didn’t even think about that.
Joe Well, for instance, the column for the publication year of a book is called
publication_year.
Theo Go on...
Joe Inside JSON, I like to use Pascal case, like publicationYear.
Theo And I’d prefer to have bookTitle instead of title.
Joe So we’re both unhappy with the JSON string that searchBooks returns if we
pass the data retrieved from the database as is.
Theo Indeed!
Joe How would you fix it?
Theo I would modify the SQL query so that it renames the columns in the results.
Here, let me show you the query.
Listing10.11 Renaming columns inside the SQL query
SELECT
title AS bookTitle,
isbn,
publication_year AS publicationYear
FROM
books
WHERE title LIKE '%habit%';
Joe That would work, but it seems a bit weird to modify an SQL query so that it fits
the naming convention of the application.
Theo Yeah, I agree. I imagine a database like MongoDB doesn’t make it easy to
rename the fields inside a query.
Joe Yep. Sometimes it makes more sense to deal with field names in application
code. How would you handle that?
Theo Well, in that case, for every map returned by the database query, I’d use a func-
tion to modify the field names.
Joe Could you show me what the code would look like?
Theo Sure. How about this?
Listing10.12 Renaming specific keys in a list of maps
function renameBookInfoKeys(bookInfo) {
return {

--- 페이지 235 끝 ---
