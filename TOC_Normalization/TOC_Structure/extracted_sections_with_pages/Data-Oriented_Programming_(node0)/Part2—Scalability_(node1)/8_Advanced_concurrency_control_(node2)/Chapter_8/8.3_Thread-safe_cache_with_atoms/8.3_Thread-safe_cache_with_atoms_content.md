# 8.3 Thread-safe cache with atoms

**페이지**: 196-197
**계층**: Data-Oriented Programming (node0) > Part2—Scalability (node1) > 8 Advanced concurrency control (node2) > Chapter 8
**추출 시간**: 2025-08-06 19:47:04

---


--- 페이지 196 ---

168 CHAPTER 8 Advanced concurrency control
stateSnapshot,
nextState)) {
Uses a special thread-safe comparison operation
continue;
as this.state might have changed in another
}
thread during execution of the function f.
return nextState;
}
}
}
Theo comes closer to the whiteboard. He modifies Joe’s diagram a bit to make the flow of
the swap operation more detailed. The resulting diagram is in figure 8.2. Theo still has a
few questions, though.
Take snapshot
snapshot = state
Compute next state
nextState = f(snapshot)
Check if state has changed
state == snapshot
Yes
State changed?
No
Update state
state = nextState
Figure 8.2 Detailed flow of swap
Theo What is atomicCompareAndSet?
Joe It’s the core operation of an atom. atomicCompareAndSet atomically sets the
state to a new value if, and only if, the state equals the provided old value. It
returns true upon success and false upon failure.
Theo How could it be atomic without using locks?
Joe That’s a great question! In fact, atomicCompareAndSet is a compare-and-swap
operation, provided by the language that relies on a functionality of the CPU
itself. For example, in Java the java.util.concurrent.atomic package has
an AtomicReference generic class that provides a compareAndSet() method.
 NOTE See http://tutorials.jenkov.com/java-concurrency/compare-and-swap.html
for general information about compare-and-swap operations. Implementations for
multi-threaded languages appear in table 8.2.

--- 페이지 196 끝 ---


--- 페이지 197 ---

8.2 Thread-safe counter with atoms 169
Table 8.2 Implementation of an atomic compare and set in various languages
Language Link
Java http://mng.bz/mx0W
JavaScript Not relevant (single-threaded language)
Ruby http://mng.bz/5KG8
Python https://github.com/maxcountryman/atomos
C# http://mng.bz/6Zzp
Theo Apropos Java, how would the implementation of an atom look?
Joe It’s quite the same, besides the fact that Atom has to use generics, and the inner
state has to be stored in an AtomicReference.
Joe brings up a Java implementation of Atom on his laptop. Theo looks over the code.
Listing8.4 Implementation of the Atom class in Java
class Atom<ValueType> {
private AtomicReference<ValueType> state;
public Atom() {}
ValueType get() {
return this.state.get();
}
this.state might have
changed in another thread
void set(ValueType state) {
during the execution of f.
this.state.set(state);
}
ValueType swap(UnaryOPerator<ValueType> f) {
while(true) {
ValueType stateSnapshot = this.state.get();
ValueType nextState = f(stateSnapshot);
if (!this.state.compareAndSet(stateSnapshot,
nextState)) {
continue;
}
}
return nextState;
}
}
Theo What about using an atom in Java?
Joe Here, take a look. It’s quite simple.

--- 페이지 197 끝 ---
