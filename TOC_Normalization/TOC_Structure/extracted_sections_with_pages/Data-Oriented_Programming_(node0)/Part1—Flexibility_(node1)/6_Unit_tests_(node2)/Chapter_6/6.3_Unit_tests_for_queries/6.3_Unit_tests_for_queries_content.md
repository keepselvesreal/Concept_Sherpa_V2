# 6.3 Unit tests for queries

**페이지**: 153-154
**계층**: Data-Oriented Programming (node0) > Part1—Flexibility (node1) > 6 Unit tests (node2) > Chapter 6
**추출 시간**: 2025-08-06 19:46:58

---


--- 페이지 153 ---

6.3 Unit tests for queries 125
_.isEqual(Catalog.searchBooksByTitle(catalogData, "Watchmen"), [bookInfo]);
_.isEqual(Catalog.searchBooksByTitle(catalogData, "Batman"), []);
Joe That’s a good start!
Theo I thought I was done. What did I miss?
Joe You forgot to test cases where the query string is all lowercase.
Theo You’re right! Let me quickly add one more test case.
In less than a minute, Theo creates an additional test case and shows it to Joe. What a dis-
appointment when Theo discovers that the test case with "watchmen" in lowercase fails!
Listing6.18 Additional test case for Catalog.searchBooksByTitle
_.isEqual(Catalog.searchBooksByTitle(catalogData, "watchmen"),
[bookInfo]);
Joe Don’t be too upset, my friend. After all, the purpose of unit tests is to find bugs
in the code so that you can fix them. Can you fix the code of Catalog-
Data.searchBooksByTitle?
Theo Sure. All I need to do is to lowercase both the query string and the book title
before comparing them. I’d probably do something like this.
Listing6.19 Fixed code of Catalog.searchBooksByTitle
Catalog.searchBooksByTitle = function(catalogData, query) {
var allBooks = _.get(catalogData, "booksByIsbn");
var queryLowerCased = query.toLowerCase();
Converts the query
var matchingBooks = _.filter(allBooks, function(book) {
to lowercase
return _.get(book, "title")
.toLowerCase()
Converts the book
.includes(queryLowerCased);
title to lowercase
});
var bookInfos = _.map(matchingBooks, function(book) {
return Catalog.bookInfo(catalogData, book);
});
return bookInfos;
};
After fixing the code of Catalog.searchBooksByTitle, Theo runs all the test cases
again. This time, all of them pass—what a relief!
Listing6.20 Additional test case for Catalog.searchBooksByTitle
_.isEqual(Catalog.searchBooksByTitle(catalogData, "watchmen"),
[bookInfo]);
Joe It’s such good feeling when all the test cases pass.
Theo Sure is.
Joe I think we’ve written unit tests for all the search query code, so now we’re ready
to write unit tests for mutations. Thank goodness the waiter just brought our
coffee orders.

--- 페이지 153 끝 ---


--- 페이지 154 ---

126 CHAPTER 6 Unit tests
6.4 Unit tests for mutations
Joe Before writing unit tests for the add member mutation, let’s draw the tree of
function calls for System.addMember.
Theo I can do that.
Theo takes a look at the code for the functions involved in the add member mutation. He
notices the code is spread over three classes: System, Library, and UserManagement.
Listing6.21 The functions involved in the add member mutation
System.addMember = function(systemState, member) {
var previous = systemState.get();
var next = Library.addMember(previous, member);
systemState.commit(previous, next);
};
Library.addMember = function(library, member) {
var currentUserManagement = _.get(library, "userManagement");
var nextUserManagement = UserManagement.addMember(
currentUserManagement, member);
var nextLibrary = _.set(library, "userManagement", nextUserManagement);
return nextLibrary;
};
UserManagement.addMember = function(userManagement, member) {
var email = _.get(member, "email");
var infoPath = ["membersByEmail", email];
if(_.has(userManagement, infoPath)) {
throw "Member already exists.";
}
var nextUserManagement = _.set(userManagement,
infoPath,
member);
return nextUserManagement;
};
Theo grabs another napkin. Drawing the tree of function calls for System.addMember is
now quite easy (see figure 6.5).
System.addMember
SystemState.get SystemState.commit Library.addMember
_.get _.set UserManagement.addMember
_.has _.set
Figure 6.5 The tree of function calls for System.addMember

--- 페이지 154 끝 ---
