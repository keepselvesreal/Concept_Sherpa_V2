# 12.6 A new gift

**페이지**: 293-295
**계층**: Data-Oriented Programming (node0) > Part3—Maintainability (node1) > 12 Advanced data validation (node2) > Chapter 12
**추출 시간**: 2025-08-06 19:47:18

---


--- 페이지 293 ---

12.5 Automatic generation of schema-based unit tests 265
},
"ut_dee": {
"id": "Lorem officia culpa qui in",
"name": "aliquip eiusmod",
"bookIsbns": [
"0661-8-5772"
]
}
}
}
Joe I see that you have some bugs in your regular expressions.
Theo How can you see that?
Joe Some of the generated ISBNs don’t seem to be valid ISBNs.
Dave You’re right. I hate regular expressions!
Joe Dave, I don’t think you’re the only one with that sentiment. Let me show you
how to implement the flow of a schema-based unit test for Catalog.search-
BooksByTitle.
Listing12.21 Implementation of the flow of a schema-based unit test
function searchBooksTest () {
var catalogRandom = JSONSchemaFaker.generate(catalogSchema);
var queryRandom = JSONSchemaFaker.generate({ "type": "string" });
Catalog.searchBooksByTitle(catalogRandom, queryRandom);
}
Dave Wait a moment. I can’t see where you check that Catalog.searchBooksBy-
Title returns a value that conforms to the return value schema.
Theo If you look closer at the code, you’ll see it.
Dave takes a closer look at the code for Catalog.searchBooksByTitle. Now he sees it.
Listing12.22 The implementation of Catalog.searchBooksByTitle
Catalog.searchBooksByTitle = function(catalogData, query) {
if(dev()) {
if(!ajv.validate(searchBooksArgsSchema, [catalogData, query])) {
var errors = ajv.errorsText(ajv.errors);
throw ("searchBooksByTitle called with invalid arguments: " +
errors);
}
}
var allBooks = _.get(catalogData, "booksByIsbn");
var matchingBooks = _.filter(allBooks, function(book) {
return _.get(book, "title").includes(query);
});
var bookInfos = _.map(matchingBooks, function(book) {
return Catalog.bookInfo(catalogData, book);
});

--- 페이지 293 끝 ---


--- 페이지 294 ---

266 CHAPTER 12 Advanced data validation
if(dev()) {
if(!ajv.validate(searchBooksResponseSchema, bookInfos)) {
var errors = ajv.errorsText(ajv.errors);
throw ("searchBooksByTitle returned an invalid value: " +
errors);
}
}
return bookInfos;
};
Dave Of course! It’s in the code of Catalog.searchBooksByTitle. If the return
value doesn’t conform to the schema, it throws an exception, and the test fails.
Joe Correct. Now, let’s improve the code of our unit test and return false when
an exception occurs inside Catalog.searchBooksByTitle.
Joe edits the test code. He shows his changes to Theo and Dave.
Listing12.23 A complete data schema-based unit test for search books
function searchBooksTest () {
var catalogRandom = JSONSchemaFaker.generate(catalogSchema);
var queryRandom = JSONSchemaFaker.generate({ "type": "string" });
try {
Catalog.searchBooksByTitle(catalogRandom, queryRandom);
return true;
} catch (error) {
return false;
}
}
Dave Let me see what happens when I run the test.
Joe Before we run it, we need to fix something in your unit test.
Dave What?
Joe The catalog data and the query are random. There’s a good chance that no
books will match the query. We need to create a query that matches at least
one book.
Dave How are we going to find a query that’s guaranteed to match at least one book?
Joe Our query will be the first letter of the first book from the catalog data that is
generated.
Joe types for a bit and shows Theo and Dave his refined test. They are delighted that Joe is
taking the time to fix their unit test.
Listing12.24 A refined data schema-based unit test for search books
function searchBooksTest () {
var catalogRandom = JSONSchemaFaker.generate(catalogSchema);
var queryRandom = JSONSchemaFaker.generate({ "type": "string" });
try {
var firstBook = _.values(_.get(catalogRandom, "booksByIsbn"))[0];

--- 페이지 294 끝 ---


--- 페이지 295 ---

12.5 Automatic generation of schema-based unit tests 267
var query = _.get(firstBook, "title").substring(0,1);
Catalog.searchBooksByTitle(catalogRandom, query);
return true;
} catch (error) {
return false;
}
}
Dave I see. It’s less complicated than what I thought. Does it happen often that you
need to tweak the random data?
Joe No, usually the random data is just fine.
Dave OK, now I’m curious to see what happens when I execute the unit test.
When Dave executes the unit test, it fails. His expression is one of bewilderment. Theo is
just astonished.
Listing12.25 Running the schema-based unit test
searchBooksTest();
// → false
Dave I think something’s wrong in the code of the unit test.
Theo Maybe the unit test caught a bug in the implementation of Catalog.search-
BooksByTitle.
Dave Let’s check it out. Is there a way to have the unit test display the return value of
the function?
Joe Yes, here it is.
Joe once again turns to his laptop to update the code. He shows the others his new unit
test that includes the return value for Catalog.searchBooksByTitle.
Listing12.26 Including the return value in the unit test output
function searchBooksTest () {
var catalogRandom = JSONSchemaFaker.generate(catalogSchema);
var queryRandom = JSONSchemaFaker.generate({ "type": "string" });
try {
var firstBook = _.values(_.get(catalogRandom, "booksByIsbn"))[0];
var query = _.get(firstBook, "title").substring(0,1);
Catalog.searchBooksByTitle(catalogRandom, query);
return true;
} catch (error) {
console.log(error);
return false;
}
}
Dave Now, let’s see what’s displayed when I again run the unit test.

--- 페이지 295 끝 ---
