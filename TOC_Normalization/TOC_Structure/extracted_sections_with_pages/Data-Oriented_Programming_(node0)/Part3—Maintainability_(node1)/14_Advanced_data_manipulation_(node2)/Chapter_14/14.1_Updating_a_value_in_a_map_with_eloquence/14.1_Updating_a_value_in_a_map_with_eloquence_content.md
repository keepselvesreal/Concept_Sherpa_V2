# 14.1 Updating a value in a map with eloquence

**페이지**: 325-327
**계층**: Data-Oriented Programming (node0) > Part3—Maintainability (node1) > 14 Advanced data manipulation (node2) > Chapter 14
**추출 시간**: 2025-08-06 19:47:22

---


--- 페이지 325 ---

14.1 Updating a value in a map with eloquence 297
Theo Do you have time to help Dave with a question about programming?
Joe Sure.
Dave Hi Joe. How are you doing?
Joe Hello Dave. Not bad. What kind of help do you need?
Dave I’m wondering if there’s a simpler way to remove duplicates inside an array
value in a map. Using _.get, _.uniq, and _.set looks quite tedious.
Joe You should build your own data manipulation tools.
Dave What do you mean?
Joe You should write a generic update function that updates a value in a map,
applying a calculation based on its current value.1
Dave What would the arguments of update be in your opinion?
Joe Put the cart before the horse.
Dave What?!
Joe Rewrite your business logic as if update were already implemented, and you’ll
discover what the arguments of update should be.
Dave I see what you mean: the horse is the implementation of update, and the cart is
the usage of update.
Joe Exactly. But remember, it’s better if you keep your update function generic.
Dave How?
Joe By not limiting it to your specific use case.
Dave I see. The implementation of update should not deal with removing duplicate
elements. Instead, it should receive the updating function—in my case,
_.uniq—as an argument.
Joe Exactly! Uh, sorry Dave, I gotta go, I just got home. Good luck!
Dave Take care, Joe, and thanks!
Dave ends the conference call. Looking at Theo, he reiterates the conversation with Joe.
Dave Joe advised me to write my own update function. For that purpose, he told me
to start by rewriting removeAuthorDuplicates as if update were already
implemented. That will allow us to make sure we get the signature of update
right.
Theo Sounds like a plan.
Dave Joe called it “putting the cart before the horse.”
Theo Joe and his funny analogies...
TIP The best way to find the signature of a custom data manipulation function is to
think about the most convenient way to use it.
Dave Anyway, the way I’d like to use update inside removeAuthorDuplicates is
like this.
1 Lodash provides an implementation of update, but for the sake of teaching, we are writing our own imple-
mentation.

--- 페이지 325 끝 ---


--- 페이지 326 ---

298 CHAPTER 14 Advanced data manipulation
Listing14.2 The code that removes duplicates in an elegant way
function removeAuthorDuplicates(book) {
return update(book, "authors", _.uniq);
}
Theo Looks good to me!
Dave Wow! Now the code with update is much more elegant than the code with
_.get and _.set!
Theo Before you implement update, I suggest that you write down in plain English
exactly what the function does.
Dave It’s quite easy: update receives a map called map, a path called path, and a
function called fun. It returns a new version of map, where path is associated
with fun(currentValue), and currentValue is the value associated with
path in map.
Thinking out loud, Dave simultaneously draws a diagram like that in figure 14.1. Theo is
becoming more and more impressed with his young protegé as he studies the figure.
{
"position" : "manager", "income"
"income" : 100000
} map fun path
update
{
"position" : "manager",
"income" : fun(100000)
res Figure 14.1 The
}
behavior of update
TIP Before implementing a custom data manipulation function, formulate in plain
English exactly what the function does.
Theo With such a clear definition, it’s going to be a piece of cake to implement
update!
After a few minutes, Dave comes up with the code. It doesn’t take long because the plain-
English diagram helps him to organize the code.
Listing14.3 A generic update function
function update(map, path, fun) {
var currentValue = _.get(map, path);
var nextValue = fun(currentValue);
return _.set(map, path, nextValue);
}

--- 페이지 326 끝 ---


--- 페이지 327 ---

14.2 Manipulating nested data 299
Theo Why don’t you see if it works with a simple case such as incrementing a number
in a map?
Dave Good idea! I’ll try multiplying a value in a map by 2 with update. How’s this
look?
Listing14.4 Multiplying a value in a map by 2
var m = {
"position": "manager",
"income": 100000
};
update(m, "income", function(x) {
return x * 2;
});
// → {"position": "manager", "income": 200000}
Theo Great! It seems to work.
14.2 Manipulating nested data
The next Monday, during Theo and Dave’s weekly sync meeting, they discuss the upcom-
ing features for Klafim. Theo fondly remembers another Monday where they met at Dave’s
family home in the country. Coming back to the present moment, Theo begins.
Theo Recently, Nancy has been asking for more and more administrative features.
Dave Like what?
Theo I’ll give you a few examples.... Let me find the email I got from Nancy yesterday.
Dave OK.
Theo Here it is. There are three feature requests for now: listing all the book author
IDs, calculating the book lending ratio, and grouping books by a physical library.
Dave What feature should I tackle first?
Theo It doesn’t matter, but you should deliver the three of these before the end of
the week. Good luck, and don’t hesitate to call me if you need help.
On Tuesday, Dave asks for Theo’s help. Dave is not pleased with how his code looks.
Dave I started to work on the three admin features, but I don’t like the code I wrote.
Let me show you the code for retrieving the list of author IDs from the list of
books returned from the database.
Theo Can you remind me what an element in a book list returned from the database
looks like?
Dave Each book is a map with an authorIds array field.
Theo OK, so it sounds like a map over the books should do it.
Dave This is what I did, but it doesn’t work as expected. Here’s my code for listing
the book author IDs.

--- 페이지 327 끝 ---
