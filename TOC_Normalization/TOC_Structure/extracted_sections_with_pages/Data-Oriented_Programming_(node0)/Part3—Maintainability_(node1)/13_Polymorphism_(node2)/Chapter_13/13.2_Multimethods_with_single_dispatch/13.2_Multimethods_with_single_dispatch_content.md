# 13.2 Multimethods with single dispatch

**페이지**: 306-308
**계층**: Data-Oriented Programming (node0) > Part3—Maintainability (node1) > 13 Polymorphism (node2) > Chapter 13
**추출 시간**: 2025-08-06 19:47:20

---


--- 페이지 306 ---

278 CHAPTER 13 Polymorphism
handled by a specific method: "dog" by greetDog, "cat" by greetCat, and
"cow" by greetCow.
Theo takes out his notebook and opens it to a blank piece of paper. He draws a diagram
like the one in figure 13.1.
"dog" greetDog
Greet as a dog
greetDispatch "cat" greetCat
Emit the animal type Greet as a cat
animal
type, name "cow" greetCow
Greet as a cow
Figure 13.1 The logic flow
of the greet multimethod
Dave Why is there an arrow between animal and the methods, in addition to the
arrows between animal and the dispatch functions?
Theo Because the arguments of a multimethod are passed to the dispatch function
and to the methods.
TIP The arguments of a multimethod are passed to the dispatch function and to the
methods.
Dave Arguments plural?... I see only a single argument.
Theo You’re right. Right now our multimethod only receives a single argument, but
soon it will receive several arguments.
Dave I see. Could you show me how to write the code for the greet multimethod?
Theo For that, we need a library. For instance, in JavaScript, the arrows/multi-
method library provides an implementation of multimethods. Basically, we call
multi to create a multimethod called method to add a method.
 NOTE See http://mng.bz/nY9v for examples and documentation about this library.
Dave Where should we start?
Theo We’ll start with multimethod initialization by creating a dispatch function
greetDispatch that defines the signature of the multimethod, validates the
arguments, and emits the type of the animal. Then we’ll pass greetDispatch
to multi in order to create the greet multimethod. Our dispatch function
would then look like this.
Listing13.6 The dispatch function for greet multimethod
function greetDispatch(animal) {
Signature definition
if(dev()) {

--- 페이지 306 끝 ---


--- 페이지 307 ---

13.2 Multimethods with single dispatch 279
if(!ajv.validate(animalSchema, animal)) {
Argument validation
var errors = ajv.errorsText(ajv.errors);
throw ("greet called with invalid arguments: " + errors);
}
}
Dispatch value
return animal.type;
}
Multimethod
initialization
var greet = multi(greetDispatch);
TIP A multimethod dispatch function is responsible for three things: it defines the sig-
nature of the multimethod, it validates the arguments, and it emits a dispatch value.
Dave What’s next?
Theo Now we need to implement a method for each dispatched value. Let’s start
with the method that deals with dogs. We create a greetDog function that
receives an animal and then add a dog method to the greet multimethod
using the method function from the arrows/multimethod library. The method
function receives two arguments: the dispatched value and a function that cor-
responds to the dispatch value.
Listing13.7 Implementation of greet method for dogs
function greetDog(animal) {
Method
console.log("Woof woof! My name is " + animal.name);
implementation
}
greet = method("dog", greetDog)(greet);
Method declaration
Dave Does the method implementation have to be in the same module as the multi-
method initialization?
Theo No, not at all! Method declarations are decoupled from multimethod initializa-
tion exactly like class definitions are decoupled from the interface definition.
That’s what make multimethods extensible.
TIP Multimethods provides extensibility by decoupling between multimethod initial-
ization and method implementations.
Dave What about cats and cows?
Theo We add their method implementations like we did for dogs.
Theo takes a moment to envision the implementation. Then he codes up two more greet
methods for cats and cows.
Listing13.8 Implementation of greet method for cats
function greetCat(animal) {
console.log("Meow! I am " + animal.name);
}
greet = method("cat", greetCat)(greet);

--- 페이지 307 끝 ---


--- 페이지 308 ---

280 CHAPTER 13 Polymorphism
Listing13.9 Implementation of greet method for cows
function greetCow(animal) {
console.log("Moo! Call me " + animal.name);
}
greet = method("cow", greetCow)(greet);
TIP In the context of multimethods, a method is a function that provides an imple-
mentation for a dispatch value.
Dave Are the names of dispatch functions and methods important?
Theo According to what I read, not really, but I like to follow a simple naming con-
vention: use the name of the multimethod (for example, greet) as a prefix for
the dispatch function (for example, greetDispatch) and the methods. Then
I’d have the Dispatch suffix for the dispatch function and a specific suffix for
each method (for example, greetDog, greetCat, and greetCow).
Dave How does the multimethod mechanism work under the hood?
Theo Internally, a multimethod maintains a hash map where the keys are the dis-
patched values, and the values are the methods. When we add a method, an
entry is added to the hash map, and when we call the multimethod, we query the
hash map to find the implementation that corresponds to the dispatched value.
Dave I don’t think you’ve told me yet how to call a multimethod.
Theo We call it as a regular function. Give me a minute, and I’ll show you an exam-
ple that calls a multimethod.
Listing13.10 Calling a multimethod like a regular function
greet(myDog);
// → "Woof woof! My name is Fido"
greet(myCat);
// → "Meow! I am Milo"
greet(myCow);
// → "Moo! Call me Clarabelle"
TIP Multimethods are called like regular functions.
Dave You told me earlier that in the dispatch function, we should validate the argu-
ments. Is that mandatory or is it a best practice?
Theo It’s a best practice.
Dave What happens if the dispatch function doesn’t validate the arguments, and we
pass an invalid argument?
Theo Like when an animal has no corresponding method?
Dave Exactly!
Theo In that case, you’ll get an error. For instance, the arrows/multimethods library
throws a NoMethodError exception.
Dave That’s annoying. Is there a way to provide a default implementation?

--- 페이지 308 끝 ---
